<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bếp - Danh sách món | PTT Team</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- CẤU HÌNH CHUNG --- */
        body {
            height: 100vh;
            overflow: hidden;
            font-family: 'Baloo 2', cursive;
            color: #333;
        }

        /* --- BACKGROUND --- */
        .bg-image-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)),
                        url('https://res.cloudinary.com/dschg4bcn/image/upload/v1764916187/BeautyPlus-IMAGE-UPSCALER-1764916129945_pskngs.jpg');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }

        /* Header */
        .kitchen-header {
            height: 70px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }

        /* User & Avatar Section */
        .user-section { display: flex; align-items: center; gap: 10px; }
        .user-avatar {
            width: 45px; height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #d35400;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .site-title { font-weight: 800; font-size: 1.3rem; text-transform: uppercase; color: #d35400; }

        /* Icon Chuông (Chỉ đổi màu, KHÔNG rung) */
        .header-icons i {
            font-size: 1.6rem; margin-left: 20px; color: #555; cursor: pointer;
            transition: color 0.3s ease;
        }
        .header-icons i:hover {
            color: #d35400;
            transform: none;
        }

        /* Layout */
        .kitchen-container { display: flex; height: calc(100vh - 70px); }

        .col-waiting {
            flex: 1; border-right: 1px solid rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            background: rgba(255, 255, 255, 0.85);
        }
        .col-cooking {
            flex: 1; display: flex; flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
        }

        /* Col Header */
        .col-header { padding: 15px 20px 0 20px; display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .col-title { font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 1.5rem; color: #555; margin-bottom: 10px; text-transform: uppercase; }

        /* Tabs */
        .tab-group { display: flex; gap: 5px; }
        .nav-tab-item {
            padding: 8px 25px; border: 1px solid #ccc; border-bottom: 3px solid transparent;
            border-radius: 10px 10px 0 0; color: #aaa; text-decoration: none; font-weight: 700;
            background: rgba(249, 249, 249, 0.8); font-size: 1rem;
        }
        .nav-tab-item.active {
            border: 1px solid #ccc; border-bottom: 3px solid #d35400;
            color: #d35400; background: #fff; position: relative; top: 1px; z-index: 2;
        }

        /* Task List */
        .task-list { flex-grow: 1; overflow-y: auto; padding: 20px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #bbb; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Card */
        .task-card {
            border: 0; border-left: 5px solid #333;
            border-radius: 10px; padding: 15px; margin-bottom: 20px;
            background: white; position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }

        .task-info { margin-bottom: 10px; max-width: 70%; }
        .dish-name { font-weight: 800; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; color: #2c3e50; }
        .dish-qty { background: #2c3e50; color: white; padding: 2px 10px; border-radius: 6px; font-size: 1rem; }
        .dish-meta { color: #7f8c8d; font-size: 1rem; font-weight: 600; margin-top: 5px; }
        .dish-note { color: #c0392b; font-style: italic; font-weight: 600; margin-top: 5px; background: #fceceb; padding: 2px 8px; border-radius: 4px; display: inline-block; }

        /* Button */
        .btn-action {
            border: 2px solid #d35400; background: white; color: #d35400;
            font-weight: 700; padding: 8px 20px; border-radius: 50px;
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            cursor: pointer; transition: 0.2s; text-transform: uppercase; font-family: 'Baloo 2', cursive;
        }
        .btn-action:hover { background: #d35400; color: white; }

        .btn-done { background: #2c3e50; color: white; border-color: #2c3e50; }
        .btn-done:hover { background: #34495e; border-color: #34495e; }

        .logout-btn {
            position: fixed; bottom: 20px; left: 20px; font-size: 1.1rem;
            color: #555; text-decoration: none; font-weight: 700;
            display: flex; align-items: center; gap: 10px; z-index: 100;
            background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .logout-btn:hover { color: #c0392b; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="bg-image-container"></div>

<div class="kitchen-header">
    <div class="d-flex gap-2 align-items-center">
        <i class="fas fa-fire-alt text-danger" style="font-size: 1.5rem;"></i>
        <span style="font-weight: 800; color: #555;">Nhà bếp</span>
    </div>

    <div class="user-section">
        {% if avatar_url %}
            <img src="{{ avatar_url }}" alt="Avatar" class="user-avatar">
        {% else %}
            <img src="https://cdn-icons-png.flaticon.com/512/3461/3461980.png" alt="Default" class="user-avatar">
        {% endif %}
        <div class="site-title">{{ user }}</div>
    </div>

    <div class="header-icons">
        <i class="far fa-bell" title="Thông báo"></i>
    </div>
</div>

<div class="kitchen-container">

    <div class="col-waiting">
        <div class="col-header">
            <div class="col-title text-secondary">Đang đợi...</div>
            <div class="tab-group">
                <a href="{{ url_for('main.bep', mode='order') }}" class="nav-tab-item {% if mode == 'order' %}active{% endif %}">Theo đơn</a>
                <a href="{{ url_for('main.bep', mode='dish') }}" class="nav-tab-item {% if mode == 'dish' %}active{% endif %}">Theo Món</a>
            </div>
        </div>
        <div style="height: 2px; background: rgba(0,0,0,0.1); width: 100%; margin-top: -2px; z-index: 1;"></div>

        <div class="task-list">
            {% for item in waiting_list %}
                {% if item.IsAggregated %}
                    <div class="task-card" style="border-left-color: #f1c40f; background: #fffcf5;">
                        <div class="task-info">
                            <div class="dish-name" style="color: #d35400;">{{ item.TenMon }} <span class="badge bg-warning text-dark ms-2">Tổng: {{ item.SoLuong }}</span></div>
                            <div class="dish-meta"><i class="fas fa-layer-group"></i> Gộp nhiều bàn</div>
                            <div class="dish-note text-muted small" style="background:none; color:#7f8c8d; padding:0; margin-top:5px;">
                                <i class="fas fa-info-circle"></i> Bấm nút nấu tất cả để xử lý nhanh
                            </div>
                        </div>
                        <button class="btn-action" onclick="updateStatus('{{ item.IDs }}', 'DangCheBien')">
                            Nấu Tất Cả
                        </button>
                    </div>
                {% else %}
                    <div class="task-card" style="border-left-color: #e74c3c;">
                        <div class="task-info">
                            <div class="dish-name">{{ item.mon_an.TenMon }} <span class="dish-qty">x{{ item.SoLuong }}</span></div>
                            <div class="dish-meta">
                                Order #{{ '%04d' % item.MaHoaDon }} | <span class="fw-bold text-dark">Bàn số {{ item.hoa_don.SoBan }}</span>
                            </div>
                            <div class="text-muted small mt-1"><i class="far fa-clock"></i> {{ item.ThoiGianGoi.strftime('%H:%M:%S') }}</div>
                            {% if item.GhiChu %}<div class="dish-note">Note: {{ item.GhiChu }}</div>{% endif %}
                        </div>
                        <button class="btn-action" onclick="updateStatus('{{ item.MaChiTiet }}', 'DangCheBien')">Bắt đầu</button>
                    </div>
                {% endif %}
            {% else %}
                <div class="text-center text-muted mt-5 opacity-50">
                    <i class="fas fa-check-circle fa-3x mb-3"></i><p>Hết món chờ!</p>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="col-cooking">
        <div class="col-header">
            <div class="col-title" style="color: #d35400;">Đang Nấu...</div>
            <div class="tab-group"><div class="nav-tab-item active">Món ăn</div></div>
        </div>
        <div style="height: 2px; background: rgba(0,0,0,0.1); width: 100%; margin-top: -2px;"></div>

        <div class="task-list">
            {% for item in cooking_list %}
            <div class="task-card" style="border-left-color: #e67e22; background: #fffbf0;">
                <div class="task-info" style="max-width: 75%;">
                    <div class="dish-name" style="color: #d35400;">
                        {{ item.mon_an.TenMon }}
                        <span class="dish-qty" style="background: #333; color: white;">x{{ item.SoLuong }}</span>
                    </div>
                    <div class="dish-meta">Order #{{ '%04d' % item.MaHoaDon }} | <span class="fw-bold">Bàn số {{ item.hoa_don.SoBan }}</span></div>
                    <div class="text-muted small mt-1" style="color:#e67e22 !important; font-weight:bold;"><i class="fas fa-fire-alt"></i> Đang nấu...</div>
                    {% if item.GhiChu %}<div class="dish-note">Note: {{ item.GhiChu }}</div>{% endif %}
                </div>
                <button class="btn-action btn-done" onclick="updateStatus('{{ item.MaChiTiet }}', 'HoanTat')">Xong</button>
            </div>
            {% else %}
                <div class="text-center text-muted mt-5 opacity-50">
                    <i class="fas fa-utensils fa-2x mb-3"></i><p>Bếp đang rảnh.</p>
                </div>
            {% endfor %}
        </div>
    </div>

</div>

<a href="{{ url_for('main.logout') }}" class="logout-btn"><i class="fas fa-sign-out-alt"></i>Đăng xuất</a>

<script>
    function updateStatus(id, status) {
        fetch('/api/update-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: id, status: status })
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) location.reload();
        });
    }

    setTimeout(() => window.location.reload(), 30000);
</script>

</body>
</html>