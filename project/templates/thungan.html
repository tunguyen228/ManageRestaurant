<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thu ngân - Thanh toán | PTT Team</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        /* --- CẤU HÌNH CHUNG --- */
        body {
            font-family: 'Baloo 2', cursive;
            height: 100vh; overflow: hidden;
            color: #333;
        }

        /* --- BACKGROUND --- */
        .bg-image-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
                        url('https://res.cloudinary.com/dschg4bcn/image/upload/v1764869749/BeautyPlus-IMAGE-UPSCALER-1764869704815_plfqzl.jpg');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }

        /* --- NAVBAR --- */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 10px 30px;
            height: 70px;
        }

        .brand-title {
            font-weight: 800; font-size: 1.4rem; color: #d35400; text-transform: uppercase;
            display: flex; align-items: center; gap: 10px;
        }

        /* Avatar Section */
        .user-profile { display: flex; align-items: center; gap: 12px; margin-right: 20px; }
        .user-avatar {
            width: 45px; height: 45px;
            border-radius: 50%; object-fit: cover;
            border: 2px solid #d35400;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .user-name { font-weight: 700; color: #2c3e50; font-size: 1rem; }

        /* Nút Đăng Xuất Hiện Đại */
        .btn-logout {
            background: white; border: 2px solid #c0392b; color: #c0392b;
            font-weight: 700; border-radius: 30px; padding: 6px 20px;
            transition: all 0.3s ease;
            text-decoration: none; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-logout:hover {
            background: #c0392b; color: white;
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4);
            transform: translateY(-2px); /* Nổi lên */
        }

        /* --- MAIN CONTENT CARD --- */
        .main-container { height: calc(100vh - 70px); padding: 20px; overflow-y: auto; }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        /* Custom Form & Table */
        .form-select, .form-control {
            border-radius: 10px; border: 1px solid #ccc;
            font-family: 'Baloo 2', cursive;
        }
        .form-select:focus, .form-control:focus {
            border-color: #d35400; box-shadow: 0 0 0 0.25rem rgba(211, 84, 0, 0.25);
        }

        .table-custom th { background-color: #fceceb !important; color: #d35400; font-weight: 700; }
        .summary-text { font-size: 1.05rem; }
        .total-pay-row {
            background-color: #fffbf0;
            border: 2px dashed #d35400;
            border-radius: 10px; padding: 10px;
            color: #d35400;
        }

        /* Nút Thanh Toán */
        .btn-checkout-custom {
            background: #27ae60; border: none; font-weight: 800;
            border-radius: 12px; transition: 0.3s;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
        }
        .btn-checkout-custom:hover:not(:disabled) {
            background: #219150; transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(39, 174, 96, 0.4);
        }
        .btn-checkout-custom:disabled { background: #95a5a6; cursor: not-allowed; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #bbb; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>

<div class="bg-image-container"></div>

<nav class="navbar navbar-expand-lg navbar-custom sticky-top">
    <div class="container-fluid">
        <div class="brand-title">
            <i class="fas fa-cash-register"></i> Thu Ngân
        </div>

        <div class="d-flex align-items-center">
            <div class="user-profile">
                <span class="user-name">{{ user }}</span>
                {% if avatar_url %}
                    <img src="{{ avatar_url }}" alt="Avatar" class="user-avatar">
                {% else %}
                    <img src="https://cdn-icons-png.flaticon.com/512/3461/3461980.png" alt="Default" class="user-avatar">
                {% endif %}
            </div>

            <a href="{{ url_for('main.logout') }}" class="btn btn-logout">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </a>
        </div>
    </div>
</nav>

<div class="container main-container">
    <div class="row h-100">
        <div class="col-md-7 mb-3">
            <div class="card glass-card p-4 h-100 shadow-sm">
                <h4 class="text-secondary fw-bold mb-3"><i class="fas fa-list-ul"></i> Chi tiết Hóa đơn</h4>

                <div class="d-flex justify-content-between align-items-end mb-4 p-3 bg-white rounded shadow-sm border">
                    <div class="w-50 me-3">
                        <label for="select_table" class="form-label fw-bold text-muted">Chọn Bàn thanh toán:</label>
                        <select id="select_table" class="form-select form-select-lg fw-bold text-dark" onchange="fetchBill()">
                            <option value="">-- Chọn bàn --</option>
                            {% for ban in list_ban %}
                                <option value="{{ ban.SoBan }}">Bàn {{ ban.SoBan }} ({{ ban.status_text }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="text-end">
                        <p class="mb-1 text-muted small">Mã HĐ: <strong id="bill_id" class="text-dark fs-5">---</strong></p>
                        <p class="mb-0 text-muted small">Giờ vào: <strong id="time_in" class="text-dark">---</strong></p>
                    </div>
                </div>

                <div class="table-responsive flex-grow-1 border rounded bg-white">
                    <table class="table table-hover table-custom mb-0">
                        <thead>
                            <tr>
                                <th class="ps-3">Tên món</th>
                                <th class="text-center">SL</th>
                                <th class="text-end">Đơn giá</th>
                                <th class="text-end pe-3">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody id="bill_items">
                            <tr><td colspan="4" class="text-center text-muted py-5"><i>Vui lòng chọn bàn để xem hóa đơn</i></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-5 mb-3">
            <div class="card glass-card p-4 h-100 shadow-sm d-flex flex-column">
                <h4 class="text-success fw-bold mb-3"><i class="fas fa-calculator"></i> Tính Toán</h4>

                <div class="flex-grow-1">
                    <div class="p-3 bg-white rounded border mb-3">
                        <p class="d-flex justify-content-between summary-text">Tổng món: <strong id="summary_quantity">0</strong></p>
                        <p class="d-flex justify-content-between summary-text">Tạm tính: <strong id="summary_subtotal">0 VNĐ</strong></p>
                        <p class="d-flex justify-content-between summary-text">VAT (10%): <strong id="summary_vat" class="text-secondary">0 VNĐ</strong></p>
                        <p class="d-flex justify-content-between summary-text text-danger border-bottom pb-2">Giảm giá: <strong id="summary_discount">0 VNĐ</strong></p>

                        <div class="d-flex justify-content-between align-items-center total-pay-row mt-2">
                            <span class="fw-bold">TỔNG CỘNG:</span>
                            <strong id="summary_total" data-total="0" class="fs-4">0 VNĐ</strong>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="customer_cash" class="form-label fw-bold text-muted">Khách đưa (VNĐ)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="fas fa-money-bill-wave text-success"></i></span>
                            <input type="text" id="customer_cash" class="form-control form-control-lg fw-bold text-success" placeholder="0" oninput="calculateChange()">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold text-muted">Tiền thừa (Trả khách)</label>
                        <input type="text" id="change_amount" class="form-control form-control-lg bg-light text-dark fw-bold border-0" value="0 VNĐ" readonly>
                    </div>
                </div>

                <button type="button" id="btn_checkout" class="btn btn-checkout-custom btn-lg w-100 py-3" onclick="checkout()" disabled>
                    <i class="fas fa-check-circle me-2"></i> Xác nhận Thanh toán
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentBillData = null;
    let currentMaHoaDon = null;

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    // Đã xóa hàm confirmLogout() vì không còn dùng

    function parseCurrency(value) {
        return parseFloat(value.replace(/\D/g, '')) || 0;
    }

    function calculateChange() {
        const cashInputFormatted = $('#customer_cash').val();
        const cashInput = parseCurrency(cashInputFormatted);

        const totalAmount = parseFloat($('#summary_total').data('total')) || 0;

        // Format lại input khi nhập
        if (cashInputFormatted) {
            $('#customer_cash').val(cashInput.toLocaleString('vi-VN'));
        }

        let changeExact = cashInput - totalAmount;

        $('#change_amount').val(formatCurrency(changeExact));

        // Logic kích hoạt nút thanh toán
        if (cashInput >= totalAmount && totalAmount > 0) {
            $('#btn_checkout').prop('disabled', false);
        } else {
            $('#btn_checkout').prop('disabled', true);
        }
    }

    function fetchBill() {
        const soBan = $('#select_table').val();

        $('#bill_items').html('<tr><td colspan="4" class="text-center text-muted py-5"><i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...</td></tr>');
        $('#summary_total').data('total', 0).text('0 VNĐ');
        $('#customer_cash').val('');
        calculateChange();
        currentBillData = null;

        if (!soBan) {
            $('#bill_items').html('<tr><td colspan="4" class="text-center text-muted py-5"><i>Vui lòng chọn bàn để xem hóa đơn</i></td></tr>');
            return;
        }

        $.get(`/api/get-bill/${soBan}`, function(response) {
            if (response.success) {
                currentBillData = response;
                currentMaHoaDon = response.ma_hoa_don;

                $('#bill_id').text(response.ma_hoa_don);
                $('#time_in').text(response.thoi_gian_vao);

                let itemsHtml = '';
                response.items.forEach(item => {
                    itemsHtml += `
                        <tr>
                            <td class="ps-3 fw-bold text-dark">${item.ten_mon} <br><small class="text-muted fw-normal">${item.ghi_chu ? '(' + item.ghi_chu + ')' : ''}</small></td>
                            <td class="text-center align-middle"><span class="badge bg-secondary rounded-pill">${item.so_luong}</span></td>
                            <td class="text-end align-middle">${formatCurrency(item.don_gia)}</td>
                            <td class="text-end align-middle pe-3 fw-bold">${formatCurrency(item.thanh_tien)}</td>
                        </tr>
                    `;
                });
                $('#bill_items').html(itemsHtml);

                const calcs = response.calculations;
                $('#summary_quantity').text(calcs.tong_so_luong);
                $('#summary_subtotal').text(formatCurrency(calcs.tam_tinh));
                $('#summary_vat').text(formatCurrency(calcs.vat));
                $('#summary_discount').text(formatCurrency(calcs.giam_gia));

                $('#summary_total').text(formatCurrency(calcs.tong_thanh_toan)).data('total', calcs.tong_thanh_toan);

                // Gợi ý tiền mặt (làm tròn lên hàng nghìn)
                const suggestedCash = Math.ceil(calcs.tong_thanh_toan / 1000) * 1000;
                $('#customer_cash').val(suggestedCash.toLocaleString('vi-VN'));

                calculateChange();

            } else {
                alert('Lỗi: ' + response.msg);
                $('#bill_items').html('<tr><td colspan="4" class="text-center text-danger py-5">Không có hóa đơn hoặc bàn đang trống!</td></tr>');
            }
        });
    }

    function checkout() {
        if (!currentMaHoaDon || currentBillData.calculations.tong_thanh_toan <= 0) {
            alert('Vui lòng chọn bàn có hóa đơn hợp lệ để thanh toán.');
            return;
        }

        if (!confirm(`Xác nhận thanh toán HĐ #${currentMaHoaDon} cho Bàn ${currentBillData.so_ban}?`)) {
            return;
        }

        $('#btn_checkout').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...');

        const postData = {
            ma_hoa_don: currentMaHoaDon,
            tong_thanh_toan: currentBillData.calculations.tong_thanh_toan,
            tien_khach_dua: parseFloat($('#customer_cash').val().replace(/\./g, '')) || 0, // Fix lỗi parse tiền có dấu chấm
            giam_gia: currentBillData.calculations.giam_gia
        };

        $.ajax({
            url: '/api/checkout',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(postData),
            success: function(response) {
                if (response.success) {
                    alert(`✅ Thanh toán thành công! Bàn ${currentBillData.so_ban} đã trống.`);
                    window.location.reload();
                } else {
                    alert('Lỗi thanh toán: ' + response.msg);
                    $('#btn_checkout').prop('disabled', false).html('<i class="fas fa-check-circle"></i> Xác nhận Thanh toán');
                }
            },
            error: function() {
                alert('Lỗi kết nối máy chủ.');
                $('#btn_checkout').prop('disabled', false).html('<i class="fas fa-check-circle"></i> Xác nhận Thanh toán');
            }
        });
    }
</script>
</body>
</html>