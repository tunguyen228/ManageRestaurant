<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω - B√°o c√°o Doanh thu | PTT Team</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <style>
        /* --- C·∫§U H√åNH CHUNG --- */
        body {
            font-family: 'Baloo 2', cursive;
            min-height: 100vh;
            color: #333;
        }

        /* --- BACKGROUND --- */
        .bg-image-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
                        url('https://res.cloudinary.com/dschg4bcn/image/upload/v1764869749/BeautyPlus-IMAGE-UPSCALER-1764869704815_plfqzl.jpg');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }

        /* --- NAVBAR --- */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 10px 30px;
            height: 70px;
        }

        .brand-title {
            font-weight: 800; font-size: 1.4rem; color: #d35400; text-transform: uppercase;
            display: flex; align-items: center; gap: 10px;
        }

        /* --- AVATAR HI·ªÇN TH·ªä (Kh√¥ng c√≥ ch·ª©c nƒÉng upload) --- */
        .user-profile {
            display: flex; align-items: center; gap: 12px; margin-right: 20px;
        }

        .user-avatar {
            width: 45px; height: 45px;
            border-radius: 50%; object-fit: cover;
            border: 2px solid #d35400;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            background: white;
        }

        .user-name { font-weight: 700; color: #2c3e50; font-size: 1.1rem; }

        /* --- N√öT ƒêƒÇNG XU·∫§T HI·ªÜN ƒê·∫†I --- */
        .btn-logout {
            background: white; border: 2px solid #c0392b; color: #c0392b;
            font-weight: 700; border-radius: 30px; padding: 6px 20px;
            text-decoration: none; display: inline-block;
            transition: all 0.3s ease;
        }
        .btn-logout:hover {
            background: #c0392b; color: white;
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4);
            transform: translateY(-2px);
        }

        /* --- CARDS & PANELS --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .kpi-card {
            height: 100%; border-radius: 15px; border: none;
            transition: transform 0.3s;
            position: relative; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .kpi-revenue { background: linear-gradient(135deg, #d35400, #e67e22); }
        .kpi-invoices { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .kpi-avg { background: linear-gradient(135deg, #c0392b, #e74c3c); }

        .kpi-icon {
            position: absolute; right: 15px; bottom: 10px;
            font-size: 4rem; opacity: 0.2; color: white;
        }

        /* Inputs & Buttons */
        .form-control { border-radius: 10px; border: 1px solid #ccc; font-family: 'Baloo 2'; }
        .form-control:focus { border-color: #d35400; box-shadow: 0 0 0 0.25rem rgba(211, 84, 0, 0.25); }

        .btn-filter { background: #d35400; color: white; border: none; font-weight: 700; border-radius: 20px; transition: 0.2s; }
        .btn-filter:hover { background: #a04000; color: white; transform: translateY(-2px); }

        .btn-today { background: #2c3e50; color: white; border: none; font-weight: 700; border-radius: 20px; transition: 0.2s; }
        .btn-today:hover { background: #1a252f; color: white; transform: translateY(-2px); }

        /* Table */
        .table-custom thead { background: #fceceb; color: #d35400; }
        .table-custom th, .table-custom td { padding: 12px; vertical-align: middle; }
    </style>
</head>
<body>

<div class="bg-image-container"></div>

<nav class="navbar navbar-expand-lg navbar-custom sticky-top">
    <div class="container-fluid">
        <div class="brand-title">
            <i class="fas fa-chart-line"></i> Dashboard Qu·∫£n L√Ω
        </div>

        <div class="d-flex align-items-center">
            <div class="user-profile">
                <span class="user-name">{{ user }}</span>
                {% if avatar_url %}
                    <img src="{{ avatar_url }}" class="user-avatar" alt="Avatar">
                {% else %}
                    <img src="https://cdn-icons-png.flaticon.com/512/3461/3461980.png" class="user-avatar" alt="Default">
                {% endif %}
            </div>

            <a href="{{ url_for('main.logout') }}" class="btn btn-logout">
                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
            </a>
        </div>
    </div>
</nav>

<div class="container py-4">
    <h2 class="mb-4 text-center text-white fw-bold" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">B√°o c√°o Ho·∫°t ƒë·ªông Kinh doanh</h2>

    <div class="card p-4 mb-4 glass-card">
        <div class="row align-items-end g-3">
            <div class="col-md-3">
                <label for="start_date" class="form-label fw-bold text-muted">T·ª´ ng√†y</label>
                <input type="date" id="start_date" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label fw-bold text-muted">ƒê·∫øn ng√†y</label>
                <input type="date" id="end_date" class="form-control">
            </div>
            <div class="col-md-6 d-flex justify-content-end gap-2">
                <button onclick="fetchReport()" class="btn btn-filter px-4 py-2 shadow-sm"><i class="fas fa-filter"></i> L·ªçc b√°o c√°o</button>
                <button onclick="setTodayFilter()" class="btn btn-today px-4 py-2 shadow-sm"><i class="far fa-calendar-alt"></i> H√¥m nay</button>
            </div>
        </div>
        <p class="mt-3 mb-0 text-muted fst-italic">D·ªØ li·ªáu hi·ªÉn th·ªã cho: <strong id="report_period" class="text-dark">H√¥m nay</strong></p>
    </div>

    <div class="row mb-4 g-4">
        <div class="col-md-4">
            <div class="card p-3 text-white kpi-card kpi-revenue">
                <div class="position-relative z-1">
                    <h5 class="opacity-75">T·ªïng Doanh Thu</h5>
                    <h2 id="kpi_revenue" class="fw-bold">0 VNƒê</h2>
                </div>
                <i class="fas fa-sack-dollar kpi-icon"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-white kpi-card kpi-invoices">
                <div class="position-relative z-1">
                    <h5 class="opacity-75">T·ªïng S·ªë H√≥a ƒê∆°n</h5>
                    <h2 id="kpi_invoices" class="fw-bold">0</h2>
                </div>
                <i class="fas fa-file-invoice kpi-icon"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-white kpi-card kpi-avg">
                <div class="position-relative z-1">
                    <h5 class="opacity-75">TB/H√≥a ƒê∆°n</h5>
                    <h2 id="kpi_avg_revenue" class="fw-bold">0 VNƒê</h2>
                </div>
                <i class="fas fa-hand-holding-usd kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card p-3 glass-card h-100">
                <h5 class="mb-3 fw-bold text-secondary text-center">T·ªâ l·ªá Doanh thu theo Nh√≥m M√≥n</h5>
                <div class="d-flex justify-content-center align-items-center h-100">
                    <canvas id="categoryChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 glass-card h-100">
                <h5 class="mb-3 fw-bold text-secondary text-center">Top 10 M√≥n B√°n Ch·∫°y Nh·∫•t</h5>
                <div class="table-responsive">
                    <table class="table table-hover table-custom table-sm mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>T√™n m√≥n</th>
                                <th class="text-end">S·ªë l∆∞·ª£ng</th>
                            </tr>
                        </thead>
                        <tbody id="top_dishes_list">
                            <tr><td colspan="3" class="text-center text-muted">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = '/api/revenue-report';
    let revenueChart = null;

    // --- LOGIC B√ÅO C√ÅO (GI·ªÆ NGUY√äN) ---
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    function formatDate(date) {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        const year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
    }

    function drawCategoryChart(data) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        const labels = data.map(d => d.category);
        const revenues = data.map(d => d.revenue);

        const backgroundColors = [
            '#d35400', '#27ae60', '#f1c40f', '#c0392b', '#8e44ad', '#2980b9', '#16a085'
        ];

        if (revenueChart) {
            revenueChart.destroy();
        }

        revenueChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: revenues,
                    backgroundColor: backgroundColors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { family: 'Baloo 2', size: 14 } }
                    }
                }
            }
        });
    }

    function displayTopDishes(data) {
        const tbody = $('#top_dishes_list');
        tbody.empty();
        if (data.length === 0) {
             tbody.append('<tr><td colspan="3" class="text-center text-muted py-3">Kh√¥ng c√≥ d·ªØ li·ªáu m√≥n b√°n ch·∫°y.</td></tr>');
             return;
        }

        data.forEach((dish, index) => {
            let badge = '';
            if (index === 0) badge = 'ü•á';
            else if (index === 1) badge = 'ü•à';
            else if (index === 2) badge = 'ü•â';
            else badge = index + 1;

            tbody.append(`
                <tr>
                    <td class="fw-bold">${badge}</td>
                    <td class="fw-bold text-dark">${dish.dish_name}</td>
                    <td class="text-end fw-bold text-primary">${dish.quantity}</td>
                </tr>
            `);
        });
    }

    function setTodayFilter() {
        const today = formatDate(new Date());
        $('#start_date').val(today);
        $('#end_date').val(today);
        fetchReport();
    }

    function fetchReport() {
        const start_date = $('#start_date').val();
        const end_date = $('#end_date').val();

        $('#kpi_revenue').text('ƒêang t·∫£i...');
        $('#kpi_invoices').text('...');
        $('#kpi_avg_revenue').text('...');
        $('#top_dishes_list').html('<tr><td colspan="3" class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>');

        $.get(API_URL, { start_date: start_date, end_date: end_date }, function(response) {
            if (response.success) {
                const summary = response.summary;

                $('#kpi_revenue').text(formatCurrency(summary.total_revenue));
                $('#kpi_invoices').text(summary.total_invoices);
                $('#kpi_avg_revenue').text(formatCurrency(summary.avg_revenue_per_invoice));
                $('#report_period').text(summary.report_period);

                drawCategoryChart(response.category_report);
                displayTopDishes(response.top_dishes);

            } else {
                alert('L·ªói b√°o c√°o: ' + response.msg);
                $('#kpi_revenue').text('0 VNƒê');
                $('#kpi_invoices').text('0');
                $('#kpi_avg_revenue').text('0 VNƒê');
                $('#top_dishes_list').html('<tr><td colspan="3" class="text-center text-danger">' + response.msg + '</td></tr>');
                $('#report_period').text('Ch∆∞a c√≥ d·ªØ li·ªáu');
            }
        }).fail(function() {
            alert('L·ªói k·∫øt n·ªëi m√°y ch·ªß ho·∫∑c quy·ªÅn truy c·∫≠p.');
        });
    }

    $(document).ready(function() {
        setTodayFilter();
    });
</script>
</body>
</html>